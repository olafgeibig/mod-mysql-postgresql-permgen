<div class="container" ng-controller="TaggingController">
    <div class="page-header">
        <h1>Push - Tag Devices</h1>
    </div>
    <div ng-show="error" class="alert alert-danger">{{errorMessage}}</div>
    <div class="row">
        <div class="col-md-12 column">
            <p>
                To tag the devices a JPQL query must be given which results in a list of
                devices. The JPQL query must be entered starting from the keyword <code>FROM</code>. The count query will
                be executed with a leading <code>SELECT COUNT(DISTINCT d.pushToken)</code> and the select query with an appended
                <code>GROUP BY d.pushToken</code>. The query must use the query variable d for a device.
                To exclude token with wrong formats the clause <code>AND d.pushToken NOT LIKE 'APA%'</code> is appended.
            </p>
            <p>
                Some Example queries:
                <ul>
                <li>
                    All devices of non-locked users
                    <strong>FROM Device d WHERE d.pushToken IS NOT NULL AND (d.user.locked=false OR d.user.locked IS NULL)</strong>
                </li>
                <li>
                    All devices of non-locked users with token who detected certain spots
                    <strong>FROM Device d WHERE d.id in ( SELECT t.trackingPK.deviceId FROM Tracking t WHERE t.spotId IN (1,2,3) ) AND d.pushToken IS NOT NULL AND (d.user.locked=false OR d.user.locked IS NULL)</strong>
                </li>
                </ul>
            </p>
            <p>
                The execution is performed with {{ metadata.threadpoolSize }} threads in chunks of
                {{ metadata.chunkSize }} devices tokens.
            </p>
            </br>
        </div>
        <div class="col-md-12 column">
            <form name="form" class="css-form" novalidate role="form">
                <div class="form-group">
                    <label>Tag</label>
                    <select id="tag" class="form-control" ng-model="query.tag" ng-options="t for t in tags" required>
                        <option value="">Select tag</option>
                    </select>
                    <p ng-show="form.tag.$invalid && !form.tag.$pristine" class="help-block">Tag is required.</p>
                </div>
                <div class="form-group">
                    <label>Query</label>
                    <textarea class="form-control" id="query" ng-model="query.query" placeholder="Enter query" required></textarea>
                    <p ng-show="form.query.$invalid && !form.query.$pristine" class="help-block">Query is required.</p>
                </div>
                <div class="form-group">
                    <label>
                        <input id="dryRun" type="checkbox" ng-model="query.dryRun"/> dry run
                    </label>
                    <p class="help-block">uncheck to really perform the operation</p>
                </div>
                <button ng-click="runTagging(query)" ng-disabled="form.$invalid" class="btn btn-default">Execute</button>
                <button ng-click="runSampling(query)" ng-disabled="form.$invalid" class="btn btn-default has-spinner">
                    <span class="spinner"><i class="icon-spin icon-refresh"></i>Sample Data</span>
                </button>
            </form>
        </div>
    </div>
    <div class="row" ng-show="jobId">
        <br>
        <div class="col-md-12 column">
            <p><strong>Tagging status: {{ jobStatus.status }}</strong></p>
            <p>Job id: {{ jobId }}</p>
            <p>Requests: {{ jobStatus.progress }}</p>
        </div>
    </div>
    <div ng-show="queryResult" class="row">
        <br>
        <div class="col-md-12 column">
            <p><strong>Tagging Result</strong></p>
            <p>Count: {{ queryResult.count }}</p>
            <p>Invalid tokens: {{ queryResult.invalidTokens.length }}</p>
            <div ng-show="queryResult.invalidTokens.length > 0" style="width: 100%; max-height:300px; margin-right: 18px;">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Token</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="t in queryResult.invalidTokens">
                        <td>{{ t }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
             <p>Unrecoverable errors: {{ queryResult.errors.length }}</p>
            <div ng-show="queryResult.errors.length > 0" style="width: 100%; max-height:300px; margin-right: 18px;">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Chunk</th>
                        <th>Status Code</th>
                        <th>Response</th>
                        <th>Request</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="r in queryResult.errors">
                        <td>{{ r.chunk }}</td>
                        <td>{{ r.responseCode }}</td>
                        <td>{{ r.content }}</td>
                        <td>{{ r.request }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div ng-show="sampleResult" class="row">
        <div class="col-md-12 column">
            <p><strong>Sample Result</strong></p>
            <p>Count: {{ sampleResult.count }}</p>
            <div style="width: 100%; overflow: auto; max-height:300px; margin-right: 18px;">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Id</th>
                        <th>User Id</th>
                        <th>User Agent</th>
                        <th>Created At</th>
                        <th>Push Token</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="r in sampleResult.rows">
                        <td>{{ r.id }}</td>
                        <td>{{ r.userId }}</td>
                        <td>{{ r.deviceUserAgent }}</td>
                        <td>{{ r.createdAt }}</td>
                        <td>{{ r.pushToken }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
